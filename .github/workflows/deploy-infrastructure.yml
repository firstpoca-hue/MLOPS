name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

env:
  TF_VAR_github_owner: ${{ github.repository_owner }}
  TF_VAR_github_repo: ${{ github.event.repository.name }}
  TF_VAR_aws_region: eu-central-1
  TF_VAR_project_name: mlops-loan-model
  TF_VAR_bucket_name: teamars-1ee00834
  TF_VAR_github_branch: main

jobs:
  terraform:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: eu-central-1

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      if: github.event.inputs.action == 'plan'
      run: |
        echo "üìã Planning MLOps infrastructure deployment..."
        terraform plan
        echo "‚úÖ Plan completed! Review the changes above."
        echo "üöÄ To deploy: Re-run workflow with 'apply' action"

    - name: Terraform Apply
      if: github.event.inputs.action == 'apply'
      run: |
        echo "üöÄ Deploying MLOps infrastructure with CodeBuild..."
        terraform apply -auto-approve
        echo "‚úÖ Infrastructure deployed successfully!"
        echo "‚ö†Ô∏è  Next step: Complete GitHub connection in AWS Console"
        echo "üìù Go to: CodePipeline ‚Üí Settings ‚Üí Connections"
        echo "üîó Find: mlops-loan-model-github-connection (PENDING)"
        echo "‚úÖ Click: Update pending connection and authorize GitHub"
        
    - name: Output Important URLs
      if: github.event.inputs.action == 'apply'
      run: |
        echo "üîó Important AWS Console Links:"
        echo "CodePipeline: https://eu-central-1.console.aws.amazon.com/codesuite/codepipeline/home"
        echo "CodeBuild: https://eu-central-1.console.aws.amazon.com/codesuite/codebuild/home"
        echo "SageMaker: https://eu-central-1.console.aws.amazon.com/sagemaker/home"
        echo "S3 Bucket: https://s3.console.aws.amazon.com/s3/buckets/teamars-1ee00834"
        echo "Connections: https://eu-central-1.console.aws.amazon.com/codesuite/settings/connections"

    - name: Terraform Destroy
      if: github.event.inputs.action == 'destroy'
      run: |
        echo "üßπ Destroying MLOps infrastructure..."
        terraform destroy -auto-approve
        echo "‚úÖ Infrastructure destroyed successfully!"