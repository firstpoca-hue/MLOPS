name: Deploy ML Model

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - delete

jobs:
  deploy-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install boto3 numpy

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: eu-central-1

    - name: Check Available Models
      if: github.event.inputs.action == 'deploy'
      run: |
        echo "üîç Checking for trained models in S3..."
        aws s3 ls s3://teamars-1ee00834/model-output/ --recursive || echo "No models found"
        
    - name: Cleanup Failed Endpoint
      if: github.event.inputs.action == 'deploy'
      run: |
        python -c "
        import boto3
        sm = boto3.client('sagemaker', region_name='eu-central-1')
        try:
            response = sm.describe_endpoint(EndpointName='loan-endpoint')
            if response['EndpointStatus'] == 'Failed':
                print('üóëÔ∏è Deleting failed endpoint...')
                sm.delete_endpoint(EndpointName='loan-endpoint')
                print('‚úÖ Failed endpoint deleted')
        except:
            pass
        "
        
    - name: Deploy Model to Endpoint
      if: github.event.inputs.action == 'deploy'
      run: |
        python deploy/deploy_model.py

    - name: Delete Endpoint
      if: github.event.inputs.action == 'delete'
      run: |
        python -c "
        import boto3
        sm = boto3.client('sagemaker', region_name='eu-central-1')
        try:
            sm.delete_endpoint(EndpointName='loan-endpoint')
            print('‚úÖ Endpoint deleted successfully')
        except Exception as e:
            print(f'‚ùå Error deleting endpoint: {e}')
        "

    - name: Check Endpoint Status
      if: github.event.inputs.action == 'deploy'
      run: |
        python -c "
        import boto3
        import time
        
        sm = boto3.client('sagemaker', region_name='eu-central-1')
        
        try:
            response = sm.describe_endpoint(EndpointName='loan-endpoint')
            status = response['EndpointStatus']
            print(f'üìä Endpoint Status: {status}')
            
            # Wait for endpoint to be ready
            while status in ['Creating', 'Updating']:
                print('‚è≥ Waiting for endpoint...')
                time.sleep(30)
                response = sm.describe_endpoint(EndpointName='loan-endpoint')
                status = response['EndpointStatus']
                print(f'üìä Endpoint Status: {status}')
                
            if status == 'InService':
                print('‚úÖ Endpoint is ready!')
            elif status == 'Failed':
                failure_reason = response.get('FailureReason', 'Unknown')
                print(f'‚ùå Endpoint failed: {failure_reason}')
            else:
                print(f'‚ùå Endpoint status: {status}')
                
        except Exception as e:
            print(f'‚ùå Endpoint not found: {e}')
        "

    - name: Test Endpoint
      if: github.event.inputs.action == 'deploy'
      run: |
        python -c "
        import boto3
        import json
        
        sm = boto3.client('sagemaker', region_name='eu-central-1')
        
        try:
            # Check if endpoint exists and is ready
            response = sm.describe_endpoint(EndpointName='loan-endpoint')
            if response['EndpointStatus'] != 'InService':
                print('‚ùå Endpoint not ready for testing')
                exit(1)
                
            runtime = boto3.client('sagemaker-runtime', region_name='eu-central-1')
            
            import numpy as np
            payload = {
                'no_of_dependents': 2,
                'education': 0,
                'self_employed': 0,
                'income_annum': np.log(5000000 + 1),
                'loan_amount': np.log(10000000 + 1),
                'loan_term': 12,
                'credit_score': 750,
                'total_asset': np.log(15000000 + 1)
            }
            
            response = runtime.invoke_endpoint(
                EndpointName='loan-endpoint',
                ContentType='application/json',
                Body=json.dumps(payload)
            )
            result = response['Body'].read().decode()
            print(f'‚úÖ Endpoint test successful: {result}')
            
        except Exception as e:
            print(f'‚ùå Endpoint test failed: {e}')
        "